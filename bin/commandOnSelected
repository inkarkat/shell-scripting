#!/bin/bash

readonly scriptFilespec="${BASH_SOURCE[0]}"

printUsage()
{
    cat <<HELPTEXT
Read entries (one per line) from GENERATOR, show a (numbered) list of them to
the user, and ask for selections (or allow further filtering of the list). The
selected ones are then passed to the COMMAND [or printed].
HELPTEXT
printf 'Usage: GENERATOR | %q %s\n' "$(basename "$1")" '[COMMAND ...] [-?|-h|--help]'
printf 'Usage: %q %s\n' "$(basename "$1")" '[COMMAND ...] \; GENERATOR ... [-?|-h|--help]'
}

typeset -a command=()
typeset -a generator=()
while [ $# -ne 0 ]
do
    case "$1" in
	--help|-h|-\?)	shift; printUsage "$0"; exit 0;;
	\;)		shift; generator=("$@"); break;;
	*)		command+=("$1")
			shift
			;;
    esac
done

if [ ${#generator[@]} -eq 0 ]; then
    mapfile -t filespecs
    { exec 0</dev/tty; } 2>/dev/null || exit $?
else
    IFS=$'\n'
    typeset -a filespecs=($("${generator[@]}"))
    IFS=
fi

if [ ${#filespecs[@]} -eq 0 ]; then
    exit 0
elif [ ${#filespecs[@]} -eq 1 ]; then
    typeset -a selectedFilespecs=("${filespecs[@]}")
else
    typeset -a selectedFilespecs=()
    select filespec in "${filespecs[@]}"
    do
	if [ "$filespec" ]; then
	    selectedFilespecs+=("$filespec")
	elif [ "$REPLY" = '.' ]; then
	    break
	elif [ "$REPLY" = '?' ]; then
	    cat >&2 <<-'EOF'
		Enter each number (one after the other) to select the entry.
		Conclude by pressing Ctrl-D or entering "."
		Filter the list by entering "grep" arguments. (Double backslashes.)
EOF
	else
	    printf '%s\n' "${filespecs[@]}" | grep $REPLY | "$scriptFilespec" "$@"
	    exit $?
	fi
    done
fi

[ ${#selectedFilespecs[@]} -eq 0 ] && exit 1

[ ${#command[@]} -eq 0 ] && command=(printf '%s\n')
exec "${command[@]}" "${selectedFilespecs[@]}"
